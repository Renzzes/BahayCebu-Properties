<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        img {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            margin: 10px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .stats {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>BahayCebu Properties - Image Upload Test</h1>
    
    <div class="test-section">
        <h2>1. Image Upload Test</h2>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="testImageUpload()">Test Upload</button>
        <div id="uploadResults"></div>
    </div>

    <div class="test-section">
        <h2>2. Agent API Test</h2>
        <button onclick="testAgentAPI()">Test Agent API</button>
        <div id="apiResults"></div>
    </div>

    <div class="test-section">
        <h2>3. Image Display Test</h2>
        <button onclick="testImageDisplay()">Test Image Display</button>
        <div id="displayResults"></div>
    </div>

    <script>
        const API_BASE = 'https://api.bahaycebu-properties.com';
        
        async function testImageUpload() {
            const input = document.getElementById('imageInput');
            const results = document.getElementById('uploadResults');
            
            if (!input.files[0]) {
                results.innerHTML = '<div class="result error">Please select an image file first</div>';
                return;
            }
            
            const file = input.files[0];
            results.innerHTML = '<div class="result">Processing image...</div>';
            
            try {
                // Test image compression
                const startTime = Date.now();
                const compressedImage = await compressImage(file);
                const compressionTime = Date.now() - startTime;
                
                const originalSize = file.size;
                const compressedSize = Math.round((compressedImage.length * 3) / 4);
                const compressionRatio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                
                results.innerHTML = `
                    <div class="result success">Image compression successful!</div>
                    <div class="stats">
                        <p>Original size: ${formatFileSize(originalSize)}</p>
                        <p>Compressed size: ${formatFileSize(compressedSize)}</p>
                        <p>Compression ratio: ${compressionRatio}%</p>
                        <p>Processing time: ${compressionTime}ms</p>
                    </div>
                    <img src="${compressedImage}" alt="Compressed image">
                `;
                
                if (compressionTime > 3000) {
                    results.innerHTML += '<div class="result warning">⚠️ Image processing is slow (>3s). This may cause performance issues.</div>';
                }
                
                if (compressedSize > 500000) {
                    results.innerHTML += '<div class="result warning">⚠️ Compressed image is still large (>500KB). This may cause slow uploads.</div>';
                }
                
            } catch (error) {
                results.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }
        
        async function testAgentAPI() {
            const results = document.getElementById('apiResults');
            results.innerHTML = '<div class="result">Testing Agent API...</div>';
            
            try {
                // Test GET agents
                const response = await fetch(`${API_BASE}/api/agents`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const agents = await response.json();
                
                results.innerHTML = `
                    <div class="result success">Agent API is working!</div>
                    <div class="stats">
                        <p>Found ${agents.length} agents</p>
                        <p>Response time: ${response.headers.get('x-response-time') || 'N/A'}</p>
                    </div>
                `;
                
                // Test if any agents have images
                const agentsWithImages = agents.filter(agent => agent.image);
                if (agentsWithImages.length > 0) {
                    results.innerHTML += `<p>Agents with images: ${agentsWithImages.length}</p>`;
                    
                    // Check image sizes
                    const imageSizes = agentsWithImages.map(agent => {
                        const size = Math.round((agent.image.length * 3) / 4);
                        return { name: agent.name, size };
                    });
                    
                    const avgSize = imageSizes.reduce((sum, item) => sum + item.size, 0) / imageSizes.length;
                    results.innerHTML += `<p>Average image size: ${formatFileSize(avgSize)}</p>`;
                    
                    if (avgSize > 200000) {
                        results.innerHTML += '<div class="result warning">⚠️ Agent images are large. This may cause slow loading.</div>';
                    }
                }
                
            } catch (error) {
                results.innerHTML = `<div class="result error">API Error: ${error.message}</div>`;
            }
        }
        
        async function testImageDisplay() {
            const results = document.getElementById('displayResults');
            results.innerHTML = '<div class="result">Testing image display...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/agents`);
                const agents = await response.json();
                
                const agentsWithImages = agents.filter(agent => agent.image);
                
                if (agentsWithImages.length === 0) {
                    results.innerHTML = '<div class="result warning">No agents with images found</div>';
                    return;
                }
                
                let html = '<div class="result success">Testing image display for agents:</div>';
                
                agentsWithImages.slice(0, 3).forEach(agent => {
                    const loadStart = Date.now();
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd;">
                            <h4>${agent.name}</h4>
                            <img src="${agent.image}" alt="${agent.name}" 
                                 onload="recordImageLoad('${agent.id}', ${loadStart})"
                                 onerror="recordImageError('${agent.id}')">
                            <div id="load-${agent.id}"></div>
                        </div>
                    `;
                });
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        }
        
        function recordImageLoad(agentId, startTime) {
            const loadTime = Date.now() - startTime;
            const element = document.getElementById(`load-${agentId}`);
            if (element) {
                element.innerHTML = `<span class="stats">Loaded in ${loadTime}ms</span>`;
                if (loadTime > 2000) {
                    element.innerHTML += ' <span style="color: orange;">⚠️ Slow loading</span>';
                }
            }
        }
        
        function recordImageError(agentId) {
            const element = document.getElementById(`load-${agentId}`);
            if (element) {
                element.innerHTML = '<span style="color: red;">❌ Failed to load</span>';
            }
        }
        
        // Image compression function (simplified version)
        function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.9) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    let { width, height } = img;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = URL.createObjectURL(file);
            });
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>